<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.A.M. - El Libro Rojo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Courier New', Courier, monospace; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .sam-input { background: transparent; border: none; outline: none; width: 100%; color: #fbbf24; }
        .horda-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.5); }
        @keyframes pulse-agressive {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 165, 0, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 5px 3px rgba(255, 165, 0, 0); }
        }
        .task-card-failed {
            opacity: 0.5;
            border-left-color: #991b1b; /* red-900 */
            transition: all 0.5s;
        }
        .animate-pulse-agressive {
            animation: pulse-agressive 2s infinite;
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center overflow-hidden">

    <div class="w-full max-w-2xl h-[90vh] glass-panel rounded-xl shadow-2xl flex flex-col relative">
        
        <header class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50 rounded-t-xl">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                <h1 class="text-xl font-bold text-amber-500 tracking-widest">S.A.M. <span class="text-xs text-slate-500">v1.0</span></h1>
            </div>
            <div id="userStatus" class="text-xs text-slate-400">Esperando conexi√≥n...</div>
        </header>

        <main id="taskContainer" class="flex-1 p-4 overflow-y-auto space-y-3 custom-scrollbar">
            <div class="text-center mt-20 text-slate-600 animate-pulse">
                Consultando el Libro Rojo...
            </div>
        </main>

        <footer class="p-4 border-t border-slate-700 bg-slate-900/80 rounded-b-xl">
            <div class="flex items-center gap-2 text-amber-500">
                <span>></span>
                <input type="text" id="chatInput" class="sam-input placeholder-slate-600" placeholder="Escribe tu gesta aqu√≠, Frodo..." autocomplete="off">
            </div>
            <div class="text-[10px] text-slate-600 mt-2 text-right">Sistema de Asistencia T√°ctica - SIEMPRE A MUERTE</div>
        </footer>

    </div>

    <script>
        // --- CONFIGURACI√ìN DE ACCESO ---
        const SUPABASE_URL = 'https://alehttakkwirudssxaru.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsZWh0dGFra3dpcnVkc3N4YXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMTc1OTMsImV4cCI6MjA4NTY5MzU5M30.zLi9AqD1JkIGGLLUmb7bTg5a9ZAK2mFh3Mr_dslcDww'; 

        // Inicializaci√≥n del Cliente (FIX: Cambio de nombre para evitar colisi√≥n)
        const { createClient } = window.supabase;
        
        // üî¥ CAMBIO AQU√ç: Usamos 'samClient' en lugar de 'supabase'
        const samClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Elementos del DOM
        const chatInput = document.getElementById('chatInput');
        const taskContainer = document.getElementById('taskContainer');
        const userStatus = document.getElementById('userStatus');

        // --- GESTI√ìN DE TOKEN ---
        async function obtenerToken() {
            // üî¥ CAMBIO AQU√ç
            const { data: { session } } = await samClient.auth.getSession();
            if (!session) {
                userStatus.textContent = "üîí Acceso Restringido (Login requerido)";
                userStatus.className = "text-xs text-red-400 font-bold";
                return null;
            }
            userStatus.textContent = `üë§ ${session.user.email}`;
            userStatus.className = "text-xs text-green-400";
            return session.access_token;
        }

        // --- FUNCI√ìN DE LOGIN MANUAL ---
        window.login = async (email, password) => {
            console.log("üîê Intentando acceder a la fortaleza...");
            // üî¥ CAMBIO AQU√ç
            const { data, error } = await samClient.auth.signInWithPassword({
                email: email,
                password: password
            });
            if (error) {
                console.error("‚ùå Error Login:", error.message);
                alert("Error: " + error.message);
            } else {
                console.log("‚úÖ Login correcto. Bienvenido, Comandante.");
                cargarMisiones();
            }
        };

        // --- CARGAR MISIONES ---
        async function cargarMisiones() {
            const token = await obtenerToken();
            
            if (!token) {
                taskContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-6">
                        <div class="text-4xl mb-4">üõ°Ô∏è</div>
                        <h2 class="text-xl text-red-400 mb-2">Acceso Denegado</h2>
                        <p class="text-sm text-slate-400 mb-4">Necesitas el Sello del Rey para leer el libro.</p>
                        <div class="bg-slate-800 p-3 rounded text-xs text-left w-full max-w-xs border border-slate-700">
                            <p class="text-amber-500 mb-1">Escribe en la consola (F12):</p>
                            <code class="text-green-400 select-all">login("tu@email.com", "tupassword")</code>
                        </div>
                    </div>
                `;
                return;
            }

            try {
                const res = await fetch('/api/tasks', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (res.status === 401) {
                    console.error("401: Token vencido");
                    return;
                }

                const data = await res.json();
                
                if (data.success) {
                    renderizarTareas(data.tasks);
                } else {
                    console.error("Error del servidor:", data.error);
                }
            } catch (e) {
                console.error("Error de red:", e);
                taskContainer.innerHTML = '<p class="text-red-500 text-center">‚ö†Ô∏è Error de conexi√≥n con SAM Server</p>';
            }
        }

        // --- RENDERIZADO VISUAL ---
        function renderizarTareas(tareas) {
            taskContainer.innerHTML = '';
            
            if (!tareas || tareas.length === 0) {
                taskContainer.innerHTML = `
                    <div class="text-center mt-20 opacity-50">
                        <p class="text-4xl mb-2">üìú</p>
                        <p class="italic">"El camino est√° despejado, Se√±or Frodo..."</p>
                    </div>`;
                return;
            }

            tareas.forEach(tarea => {
                const horda = tarea.horda || { exploradores: 0, orcos: 0, urukhai: 0 };
                
                const card = document.createElement('div');
card.className = `bg-slate-800/80 p-4 rounded-lg border-l-4 border-amber-600 shadow-lg hover:bg-slate-800 transition-colors task-card`;
                card.dataset.taskId = tarea.id; // A√±adimos un identificador para encontrarla f√°cilmenteme>
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-amber-100">${tarea.titulo_epico}</h3>
                            <div class="flex gap-2 mt-1">
                                <span class="text-[10px] uppercase bg-slate-900 px-2 py-0.5 rounded text-slate-400 border border-slate-700">${tarea.categoria}</span>
                            </div>
                        </div>
                        <div class="flex gap-1 text-xs">
                            <span class="horda-badge flex items-center gap-1 ${horda.exploradores > 0 ? 'text-green-400' : 'opacity-20'}">
                                üìç ${horda.exploradores}
                            </span>
                            <span class="horda-badge flex items-center gap-1 ${horda.orcos > 0 ? 'text-orange-400 animate-pulse-agressive' : 'opacity-20'}">
                                üëπ ${horda.orcos}
                            </span>
                            <span class="horda-badge flex items-center gap-1 ${horda.urukhai > 0 ? 'text-purple-400 font-bold animate-pulse-agressive' : 'opacity-20'}">
                                ‚öîÔ∏è ${horda.urukhai}
                            </span>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-3 pt-2 border-t border-slate-700/50">
                        <button onclick="juicioGandalf('${tarea.id}', 'exito')" class="flex-1 bg-green-900/30 hover:bg-green-700/50 text-green-300 text-xs py-1.5 rounded border border-green-900 transition-all">
                            ‚úÖ Gesta Cumplida
                        </button>
                        <button onclick="juicioGandalf('${tarea.id}', 'fracaso')" class="flex-1 bg-red-900/30 hover:bg-red-700/50 text-red-300 text-xs py-1.5 rounded border border-red-900 transition-all">
                            üî• Ca√≠da en Sombra
                        </button>
                    </div>
                `;
                taskContainer.appendChild(card);
            });
        }

        function mostrarRespuestaSam(mensajes) {
            const samReplyContainer = document.createElement('div');
            samReplyContainer.className = "bg-slate-900/50 border border-amber-900/50 p-3 rounded-lg mb-3 text-center";
            
            mensajes.forEach(msg => {
                const p = document.createElement('p');
                p.className = "text-amber-200 text-sm italic";
                p.innerHTML = `"${msg.reply}"`;
                samReplyContainer.appendChild(p);
            });
            
            taskContainer.prepend(samReplyContainer);

            // El eco se desvanece para dar paso a la acci√≥n
            setTimeout(() => {
                samReplyContainer.style.transition = 'opacity 0.5s';
                samReplyContainer.style.opacity = '0';
                setTimeout(() => samReplyContainer.remove(), 500);
            }, 4000); // Sam habla durante 4 segundos
        }

        // --- ENVIAR NUEVA MISI√ìN ---
        chatInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const text = chatInput.value;
                if(!text.trim()) return;

                chatInput.value = ''; 
                const token = await obtenerToken();

                if (!token) {
                    alert("‚ö†Ô∏è ¬°Alto ah√≠! Identif√≠cate primero.");
                    return;
                }

                const tempMsg = document.createElement('div');
                tempMsg.className = "text-xs text-amber-500/50 italic p-2";
                tempMsg.innerText = "> Enviando cuervos a Mordor...";
                taskContainer.prepend(tempMsg);

                try {
                    const res = await fetch('/api/briefing', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ userInput: text })
                    });

                    const data = await res.json();
                    tempMsg.remove(); // Quitamos el mensaje de "enviando..."

                    if (data.success && data.mensajes) {
                        mostrarRespuestaSam(data.mensajes);
                        // Esperamos un poco a que el usuario lea el mensaje antes de recargar
                        setTimeout(() => {
                            cargarMisiones(); 
                        }, 2000); // 2 segundos de respiro
                    } else {
                        // Si falla, mostramos el error que pueda venir del backend
                        const errorMsg = data.error || "La respuesta de Sam se perdi√≥ en el viento.";
                        mostrarRespuestaSam([{ reply: errorMsg }]);
                    }
                } catch(err) {
                    console.error(err);
                    tempMsg.innerText = "‚ùå Error al contactar con Sam.";
                    tempMsg.className = "text-xs text-red-500 p-2";
                }
            }
        });

        // --- JUICIO DE GANDALF ---
        window.juicioGandalf = async (id, veredicto) => {
            const token = await obtenerToken();
            if (!token) return;

            const cardElement = document.querySelector(`[data-task-id="${id}"]`);

            if (veredicto === 'fracaso') {
                if (cardElement) {
                    cardElement.classList.add('task-card-failed');
                    const hordaContainer = cardElement.querySelector('.flex.gap-1.text-xs');
                    if(hordaContainer) {
                        hordaContainer.innerHTML += `<span class="text-xs text-red-400 animate-pulse">üå±</span>`;
                    }
                }
            } else {
                 if (cardElement) {
                    cardElement.style.transition = 'opacity 0.5s';
                    cardElement.style.opacity = '0';
                    setTimeout(() => cardElement.remove(), 500);
                }
            }

            const body = veredicto === 'exito' ? { successIds: [id] } : { failureIds: [id] };

            try {
                const res = await fetch('/api/gandalf/judge', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });
                if (!res.ok) {
                    // Si el backend falla, restauramos la UI para no mentir al usuario
                    console.error("Fallo del Juicio en el backend. Revirtiendo UI.");
                    cargarMisiones(); 
                }
                // Si el √©xito fue real, la tarjeta ya ha sido eliminada o marcada.
                // No es necesario un refresco completo, ahorramos una llamada de red.
                
            } catch (err) {
                console.error("Error en el juicio:", err);
                cargarMisiones(); // En caso de error de red, resincronizamos todo
            }
        };

        // INICIO
        cargarMisiones();

    </script>
</body>
</html>