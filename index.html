<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.A.M. - El Libro Rojo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Scroll antiguo */
        #chat::-webkit-scrollbar { width: 5px; }
        #chat::-webkit-scrollbar-track { background: #1e293b; }
        #chat::-webkit-scrollbar-thumb { background: #b45309; border-radius: 10px; }
        
        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>

<body class="bg-slate-950 text-amber-50 min-h-screen flex flex-col items-center p-4">

    <div class="max-w-md w-full space-y-6">

        <header class="text-center mt-4">
            <h1 class="text-3xl font-serif text-amber-500 font-bold tracking-widest uppercase">üìú El Libro Rojo</h1>
            <p class="text-xs text-slate-500 mt-1 uppercase tracking-tighter italic">Cr√≥nicas de la Tierra Media y tu Productividad</p>
        </header>

        <div class="bg-slate-900 p-6 rounded-2xl shadow-[0_0_50px_-12px_rgba(180,83,9,0.3)] border border-amber-900/40">
            
            <div id="chat" class="mb-4 h-48 overflow-y-auto text-sm space-y-4 border-b border-slate-800 pb-4 pr-2">
                <div class="flex flex-col">
                    <span class="text-amber-600 font-bold text-xs uppercase">Sam:</span>
                    <p class="italic text-slate-400">"¬øQu√© planes tenemos para hoy, se√±or Frodo? Decidme vuestras cargas."</p>
                </div>
            </div>

            <div class="space-y-3">
                <textarea id="userInput"
                    class="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-white focus:outline-none focus:ring-2 focus:ring-amber-700 focus:border-transparent transition-all placeholder:text-slate-700"
                    placeholder="Ej: Estudiar runas, limpiar la espada y descansar..."
                    rows="2"></textarea>

                <button onclick="enviarMision()" id="btnEnviar"
                    class="w-full bg-amber-800 hover:bg-amber-700 text-amber-50 font-bold py-3 px-4 rounded-lg transition-all transform active:scale-95 shadow-lg flex items-center justify-center">
                    <span>Anotar Gesta</span>
                </button>
                
                <div class="flex items-start gap-2 px-1 mt-2 opacity-70">
                    <span class="text-amber-600 text-lg">üí°</span>
                    <p class="text-[10px] text-slate-400 leading-tight italic">
                        <span class="text-amber-600 font-bold">Consejo:</span> 
                        Puedes dictar varias gestas a la vez separadas por 
                        <span class="text-slate-200 font-mono bg-slate-800 px-1 rounded">,</span> 
                        o 
                        <span class="text-slate-200 font-mono bg-slate-800 px-1 rounded">y</span>.
                    </p>
                </div>
            </div>
        </div>

        <div class="w-full">
            <h2 class="text-amber-500 text-xs font-bold uppercase tracking-widest mb-3 ml-1 border-l-2 border-amber-600 pl-2">
                Misiones en Curso
            </h2>
            <div id="lista-misiones" class="space-y-3 pb-8">
                <p class="text-center text-slate-600 text-xs italic py-4">Consultando el libro...</p>
            </div>
        </div>

    </div>

    <footer class="fixed bottom-2 text-[10px] text-slate-700 uppercase tracking-widest font-mono">
        S.A.M. v0.5 - Alpha
    </footer>

    <script>
        const frasesCarga = [
            "Afilando la pluma...", "Consultando mapas...", "¬°Caray! Un segundo...", 
            "Preparando provisiones...", "El Senescal revisa..."
        ];

        // --- AL CARGAR LA P√ÅGINA ---
        document.addEventListener('DOMContentLoaded', cargarMisiones);

        // --- FUNCI√ìN PARA LEER MISIONES DEL BACKEND ---
        async function cargarMisiones() {
            const lista = document.getElementById('lista-misiones');
            try {
                const response = await fetch('/api/tasks');
                const data = await response.json();

                if (data.success && data.tasks.length > 0) {
                    lista.innerHTML = ''; // Limpiar mensaje de carga
                    
                    data.tasks.forEach(task => {
                        // Creamos la tarjeta HTML para cada tarea
                        const card = document.createElement('div');
                        card.className = "bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-sm flex flex-col gap-1 animate-fade-in";
                        
                        // Icono seg√∫n categor√≠a
                        let icono = "üìç";
                        if(task.categoria === "trabajo") icono = "‚öíÔ∏è";
                        if(task.categoria === "salud") icono = "‚ù§Ô∏è";
                        if(task.categoria === "estudio") icono = "üìú";
                        if(task.categoria === "ocio") icono = "üç∫";
                        if(task.categoria === "hogar") icono = "üè°";

                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <h3 class="text-amber-100 font-bold text-sm leading-tight">${task.titulo_epico}</h3>
                                <span class="text-[10px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded-full uppercase tracking-wider border border-slate-700">
                                    ${icono} ${task.categoria}
                                </span>
                            </div>
                            <p class="text-slate-500 text-xs italic">"${task.titulo_original}"</p>
                            <div class="mt-2 flex justify-between items-center">
                                <span class="text-[10px] text-red-400 font-mono">Enemigo: ${task.estado_enemigo}</span>
                                </div>
                        `;
                        lista.appendChild(card);
                    });
                } else {
                    lista.innerHTML = `<p class="text-center text-slate-600 text-xs italic py-4">No hay gestas activas. La Comarca est√° en paz.</p>`;
                }
            } catch (error) {
                console.error("Error cargando misiones:", error);
                lista.innerHTML = `<p class="text-red-500 text-xs text-center">No se pudo leer el libro.</p>`;
            }
        }

        // --- TU FUNCI√ìN DE ENVIAR (MODIFICADA PARA RECARGAR LISTA) ---
        async function enviarMision() {
            const input = document.getElementById('userInput');
            const chat = document.getElementById('chat');
            const btn = document.getElementById('btnEnviar');
            const textoUsuario = input.value.trim();

            if (!textoUsuario) return;

            // UI de carga
            const fraseRandom = frasesCarga[Math.floor(Math.random() * frasesCarga.length)];
            const btnSpan = btn.querySelector('span');
            const originalText = btnSpan.innerText;
            btnSpan.innerText = fraseRandom;
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                // Mensaje usuario
                chat.innerHTML += `
                    <div class="flex flex-col items-end text-right animate-fade-in mb-2">
                        <span class="text-slate-500 font-bold text-[10px] uppercase">T√∫</span>
                        <p class="text-amber-200">${textoUsuario}</p>
                    </div>
                `;
                chat.scrollTop = chat.scrollHeight;

                // Llamada al servidor
                const response = await fetch('/api/briefing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userInput: textoUsuario })
                });
                const data = await response.json();

                // Renderizar respuesta de Sam
                if (data.mensajes && Array.isArray(data.mensajes)) {
                    data.mensajes.forEach(gesta => {
                        chat.innerHTML += `
                            <div class="flex flex-col animate-fade-in mt-2 border-l-2 border-amber-600 pl-2">
                                <span class="text-amber-600 font-bold text-xs uppercase">${data.emisor}:</span>
                                <p class="text-white italic">"${gesta.reply}"</p>
                            </div>
                        `;
                    });
                    
                    // ‚ú® MAGIA: RECARGAMOS LA LISTA DE MISIONES AUTOM√ÅTICAMENTE
                    await cargarMisiones(); 
                }

                input.value = "";
                chat.scrollTop = chat.scrollHeight;

            } catch (error) {
                console.error("Error:", error);
                chat.innerHTML += `<p class="text-red-500 text-xs italic">Error de conexi√≥n...</p>`;
            } finally {
                btnSpan.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                input.focus();
            }
        }

        // Enter para enviar
        document.getElementById('userInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                enviarMision();
            }
        });
    </script>
</body>
</html>