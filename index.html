<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.A.M. - El Libro Rojo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Courier New', Courier, monospace; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .sam-input { background: transparent; border: none; outline: none; width: 100%; color: #fbbf24; }
        .horda-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.5); }
        @keyframes pulse-agressive {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 165, 0, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 5px 3px rgba(255, 165, 0, 0); }
        }
        .task-card-failed {
            opacity: 0.5;
            border-left-color: #991b1b; /* red-900 */
            transition: all 0.5s;
        }
        .sam-input:disabled { color: #475569; }
        .gandalf-modal {
            background-color: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid #b45309; /* amber-700 */
        }
        .shadow-level-1 { filter: brightness(0.95) saturate(0.9); }
        .shadow-level-2 { filter: brightness(0.8) saturate(0.7) sepia(0.2); }
        .shadow-level-3 { filter: brightness(0.7) saturate(0.6) sepia(0.4); }
        .shadow-vignette::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            box-shadow: inset 0 0 100px rgba(127, 29, 29, 0.7);
            pointer-events: none;
        }
        .dev-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #fbbf24;
            color: #fbbf24;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 100;
        }
        .gandalf-scroll {
            background-image: linear-gradient(to bottom, rgba(254, 243, 199, 0.9), rgba(252, 211, 77, 0.9));
            color: #451a03; /* amber-950 */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center overflow-hidden">

    <div class="w-full max-w-2xl h-[90vh] glass-panel rounded-xl shadow-2xl flex flex-col relative">
        
        <header class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50 rounded-t-xl">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                <h1 class="text-xl font-bold text-amber-500 tracking-widest">S.A.M. <span class="text-xs text-slate-500">v1.0</span></h1>
            </div>
            <div id="userStatus" class="text-xs text-slate-400">Esperando conexi√≥n...</div>
        </header>

        <!-- Panel del Juicio de Gandalf (Oculto por defecto) -->
        <div id="gandalfModal" class="hidden absolute inset-0 z-10 p-4 flex flex-col items-center justify-center gandalf-modal">
            <div class="w-full h-full max-h-[80vh] gandalf-scroll rounded-lg border-2 border-amber-800 flex flex-col p-6">
                <h2 class="text-2xl font-bold text-center mb-4 border-b-2 border-amber-800/30 pb-2">Un Asunto Pendiente</h2>
                <p class="text-center text-sm mb-6">"Un mago nunca llega tarde, Frodo Bols√≥n. Ni pronto. Llega precisamente cuando se lo propone. Y hoy me propongo resolver esto."</p>
                <div id="gandalfTaskList" class="flex-1 overflow-y-auto space-y-4 pr-2">
                    <!-- Las tareas pendientes se inyectar√°n aqu√≠ -->
                </div>
                <button id="sellarJuicioBtn" class="w-full mt-6 bg-amber-800 hover:bg-amber-700 text-amber-100 font-bold py-3 rounded-lg shadow-lg">Sellar el Juicio</button>
            </div>
        </div>

        <!-- Panel Persistente del Mensaje de Sam -->
        <div id="samReplyContainer" class="p-2 border-b border-slate-700"></div>

        <main id="taskContainer" class="flex-1 p-4 overflow-y-auto space-y-3 custom-scrollbar">
            <div class="text-center mt-20 text-slate-600 animate-pulse">
                Consultando el Libro Rojo...
            </div>
        </main>

        <footer class="p-4 border-t border-slate-700 bg-slate-900/80 rounded-b-xl">
            <div class="flex items-center gap-2 text-amber-500">
                <span>></span>
                <input type="text" id="chatInput" class="sam-input placeholder-slate-600" placeholder="Escribe tu gesta aqu√≠, Frodo..." autocomplete="off">
            </div>
            <div class="text-[10px] text-slate-600 mt-2 text-right">Sistema de Asistencia T√°ctica - SIEMPRE A MUERTE</div>
        </footer>

    </div>

    <!-- Panel de Desarrollador para Time Mocking -->
    <div id="devPanel" class="hidden dev-panel">
        <h4 class="font-bold mb-2">M√°quina del Tiempo</h4>
        <label for="daysOffset">Adelantar D√≠as:</label>
        <input type="number" id="daysOffset" value="0" class="bg-slate-800 text-amber-400 w-16 text-center">
        <button id="timeTravelBtn" class="bg-amber-600 text-black px-2 py-1 rounded">Viajar</button>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE ACCESO ---
        const SUPABASE_URL = 'https://alehttakkwirudssxaru.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsZWh0dGFra3dpcnVkc3N4YXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMTc1OTMsImV4cCI6MjA4NTY5MzU5M30.zLi9AqD1JkIGGLLUmb7bTg5a9ZAK2mFh3Mr_dslcDww'; 

        // Inicializaci√≥n del Cliente (FIX: Cambio de nombre para evitar colisi√≥n)
        const { createClient } = window.supabase;
        
        // üî¥ CAMBIO AQU√ç: Usamos 'samClient' en lugar de 'supabase'
        const samClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Elementos del DOM
        const chatInput = document.getElementById('chatInput');
        const taskContainer = document.getElementById('taskContainer');
        const userStatus = document.getElementById('userStatus');
        const samReplyContainer = document.getElementById('samReplyContainer');
        const gandalfModal = document.getElementById('gandalfModal');
        const gandalfTaskList = document.getElementById('gandalfTaskList');
        const sellarJuicioBtn = document.getElementById('sellarJuicioBtn');

        // --- GESTI√ìN DE TOKEN ---
        async function obtenerToken() {
            // üî¥ CAMBIO AQU√ç
            const { data: { session } } = await samClient.auth.getSession();
            if (!session) {
                userStatus.textContent = "üîí Acceso Restringido (Login requerido)";
                userStatus.className = "text-xs text-red-400 font-bold";
                return null;
            }
            userStatus.textContent = `üë§ ${session.user.email}`;
            userStatus.className = "text-xs text-green-400";
            return session.access_token;
        }

        // --- FUNCI√ìN DE LOGIN MANUAL ---
        window.login = async (email, password) => {
            console.log("üîê Intentando acceder a la fortaleza...");
            // üî¥ CAMBIO AQU√ç
            const { data, error } = await samClient.auth.signInWithPassword({
                email: email,
                password: password
            });
            if (error) {
                console.error("‚ùå Error Login:", error.message);
                alert("Error: " + error.message);
            } else {
                console.log("‚úÖ Login correcto. Bienvenido, Comandante.");
                cargarMisiones();
            }
        };

        // --- CARGAR MISIONES ---
        async function cargarMisiones(mockDate = null) {
            const token = await obtenerToken();
            
            if (!token) {
                taskContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-6">
                        <div class="text-4xl mb-4">üõ°Ô∏è</div>
                        <h2 class="text-xl text-red-400 mb-2">Acceso Denegado</h2>
                        <p class="text-sm text-slate-400 mb-4">Necesitas el Sello del Rey para leer el libro.</p>
                        <div class="bg-slate-800 p-3 rounded text-xs text-left w-full max-w-xs border border-slate-700">
                            <p class="text-amber-500 mb-1">Escribe en la consola (F12):</p>
                            <code class="text-green-400 select-all">login("tu@email.com", "tupassword")</code>
                        </div>
                    </div>
                `;
                return;
            }

            const url = mockDate ? `/api/tasks?mockDate=${mockDate.toISOString()}` : '/api/tasks';

            try {
                const res = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (res.status === 401) {
                    console.error("401: Token vencido");
                    return;
                }

                const data = await res.json();
                
                if (data.success) {
                    // SEPARAR TAREAS: Juicio de Gandalf vs. Gestas del d√≠a
                    const nivelSombra = actualizarNivelSombra(data.tasks);
                    
                    const { tareasPendientesDeJuicio, tareasDeHoy } = separarTareas(data.tasks, nivelSombra);

                    if (tareasPendientesDeJuicio.length > 0) {
                        activarJuicioGandalf(tareasPendientesDeJuicio);
                    } else {
                        chatInput.disabled = false;
                        gandalfModal.classList.add('hidden');
                        // Saludo din√°mico de Sam
                        const saludoInicial = nivelSombra > 1 
                            ? { reply: "Se√±or... la oscuridad es densa hoy. Debemos actuar." }
                            : { reply: "¬°Listo para la aventura, Se√±or Frodo! ¬øQu√© haza√±as nos aguardan hoy?" };
                        mostrarRespuestaSam([saludoInicial], true);
                    }
                    
                    renderizarTareas(tareasDeHoy);
                } else {
                    console.error("Error del servidor:", data.error);
                }
            } catch (e) {
                console.error("Error de red:", e);
                taskContainer.innerHTML = '<p class="text-red-500 text-center">‚ö†Ô∏è Error de conexi√≥n con SAM Server</p>';
            }
        }

        function esAnteriorAHoy(fecha) {
            const fechaTarea = new Date(fecha);
            const hoy = new Date();
            // Ignoramos la hora, comparamos solo el d√≠a
            hoy.setHours(0, 0, 0, 0);
            return fechaTarea < hoy;
        }

        function separarTareas(tareas) {
            const tareasPendientesDeJuicio = [];
            const tareasDeHoy = [];

            tareas.forEach(tarea => {
                // Una tarea est√° pendiente de juicio si NO est√° completada, NO ha sido confirmada como fallida, Y es de un d√≠a anterior.
                if (!tarea.is_completed && !tarea.fallo_confirmado && esAnteriorAHoy(tarea.created_at)) {
                    tareasPendientesDeJuicio.push(tarea);
                } else {
                    tareasDeHoy.push(tarea);
                }
            });
            return { tareasPendientesDeJuicio, tareasDeHoy };
        }

        function actualizarNivelSombra(tareas) {
            const totalEnemigos = tareas.reduce((sum, tarea) => {
                const horda = tarea.horda || { exploradores: 0, orcos: 0, urukhai: 0 };
                return sum + horda.exploradores + horda.orcos + horda.urukhai;
            }, 0);

            const body = document.body;
            body.classList.remove('shadow-level-1', 'shadow-level-2', 'shadow-level-3', 'shadow-vignette');

            let nivelSombra = 0;
            if (totalEnemigos >= 1 && totalEnemigos <= 5) {
                body.classList.add('shadow-level-1');
                nivelSombra = 1;
            } else if (totalEnemigos >= 6 && totalEnemigos <= 15) {
                body.classList.add('shadow-level-2');
                nivelSombra = 2;
            } else if (totalEnemigos > 15) {
                body.classList.add('shadow-level-3');
                body.classList.add('shadow-vignette');
                nivelSombra = 3;
            }
            return nivelSombra; // Devolvemos el nivel para el saludo de Sam
        }

        // --- RENDERIZADO VISUAL ---
        function renderizarTareas(tareas) {
            taskContainer.innerHTML = '';
            
            if (!tareas || tareas.length === 0) {
                taskContainer.innerHTML = `
                    <div class="text-center mt-20 opacity-50">
                        <p class="text-4xl mb-2">üìú</p>
                        <p class="italic">"El camino est√° despejado, Se√±or Frodo..."</p>
                    </div>`;
                return;
            }

            tareas.forEach(tarea => {
                const horda = tarea.horda || { exploradores: 0, orcos: 0, urukhai: 0 };
                
                const card = document.createElement('div');
                const esFallida = tarea.fallo_confirmado === true;

                card.className = `bg-slate-800/80 p-4 rounded-lg border-l-4 shadow-lg transition-colors task-card ${esFallida ? 'task-card-failed' : 'border-amber-600 hover:bg-slate-800'}`;
                card.dataset.taskId = tarea.id;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-amber-100">${tarea.titulo_epico}</h3>
                            <div class="flex gap-2 mt-1">
                                <span class="text-[10px] uppercase bg-slate-900 px-2 py-0.5 rounded text-slate-400 border border-slate-700">${tarea.categoria}</span>
                                ${esFallida ? `<span class="text-[10px] uppercase bg-red-900/50 px-2 py-0.5 rounded text-red-300 border border-red-800">Fallida</span>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-1 text-xs">
                            <span class="horda-badge flex items-center gap-1 ${horda.exploradores > 0 ? 'text-green-400' : 'opacity-20'}">
                                üìç ${horda.exploradores}
                            </span>
                            <span class="horda-badge flex items-center gap-1 ${horda.orcos > 0 ? 'text-orange-400 animate-pulse-agressive' : 'opacity-20'}">
                                üëπ ${horda.orcos}
                            </span>
                            <span class="horda-badge flex items-center gap-1 ${horda.urukhai > 0 ? 'text-purple-400 font-bold animate-pulse-agressive' : 'opacity-20'}">
                                ‚öîÔ∏è ${horda.urukhai}
                            </span>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-3 pt-2 border-t border-slate-700/50">
                        <button onclick="juicioGandalf('${tarea.id}', 'exito')" class="flex-1 bg-green-900/30 hover:bg-green-700/50 text-green-300 text-xs py-1.5 rounded border border-green-900 transition-all disabled:opacity-50 disabled:cursor-not-allowed" ${esFallida ? 'disabled' : ''}>
                            ‚úÖ Gesta Cumplida
                        </button>
                        <button onclick="juicioGandalf('${tarea.id}', 'fracaso')" class="flex-1 bg-red-900/30 hover:bg-red-700/50 text-red-300 text-xs py-1.5 rounded border border-red-900 transition-all disabled:opacity-50 disabled:cursor-not-allowed" ${esFallida ? 'disabled' : ''}>
                            üî• Ca√≠da en Sombra
                        </button>
                    </div>
                `;
                taskContainer.appendChild(card);
            });
        }

        function mostrarRespuestaSam(mensajes, esSaludo = false) {
            // Si es un saludo, no limpiamos. Si es una respuesta, s√≠.
            if (!esSaludo) {
                samReplyContainer.innerHTML = ''; 
            }
            // Si el panel est√° vac√≠o y es un saludo, lo mostramos.
            if (esSaludo && samReplyContainer.innerHTML !== '') return; 

            mensajes.forEach(msg => {
                const p = document.createElement('p');
                p.className = "text-amber-200 text-sm italic text-center";
                p.innerHTML = `&ldquo;${msg.reply}&rdquo;`;
                samReplyContainer.appendChild(p);
            });
        }

        // --- ENVIAR NUEVA MISI√ìN ---
        chatInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const text = chatInput.value;
                if(!text.trim()) return;

                chatInput.value = ''; 
                const token = await obtenerToken();

                if (!token) {
                    alert("‚ö†Ô∏è ¬°Alto ah√≠! Identif√≠cate primero.");
                    return;
                }

                const tempMsg = document.createElement('div');
                tempMsg.className = "flex items-center justify-center gap-3 text-xs text-amber-500/50 italic p-2";
                tempMsg.innerHTML = `
                    <svg class="animate-spin h-5 w-5 text-amber-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Afilando la pluma para el Libro Rojo...</span>
                `;
                taskContainer.prepend(tempMsg);

                try {
                    const res = await fetch('/api/briefing', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ userInput: text })
                    });

                    const data = await res.json();
                    tempMsg.remove(); // Quitamos el mensaje de "enviando..."

                    if (data.success && data.mensajes) {
                        mostrarRespuestaSam(data.mensajes);
                        // Esperamos un poco a que el usuario lea el mensaje antes de recargar
                        setTimeout(() => {
                            cargarMisiones(); 
                        }, 2000); // 2 segundos de respiro
                    } else {
                        // Si falla, mostramos el error que pueda venir del backend
                        const errorMsg = data.error || "La respuesta de Sam se perdi√≥ en el viento.";
                        mostrarRespuestaSam([{ reply: errorMsg }]);
                    }
                } catch(err) {
                    console.error(err);
                    tempMsg.innerText = "‚ùå Error al contactar con Sam.";
                    tempMsg.className = "text-xs text-red-500 p-2";
                }
            }
        });

        // --- L√ìGICA DEL JUICIO DE GANDALF ---
        let juiciosPendientes = {}; // { 'task-id': 'exito' | 'fracaso' }

        function activarJuicioGandalf(tareas) {
            console.log("¬°Gandalf interrumpe! Tareas pendientes de juicio:", tareas);
            chatInput.disabled = true;
            chatInput.placeholder = "Debes resolver los asuntos pendientes...";
            gandalfModal.classList.remove('hidden');
            gandalfTaskList.innerHTML = ''; 
            juiciosPendientes = {};

            tareas.forEach(tarea => {
                const div = document.createElement('div');
                div.className = "p-3 bg-amber-100/50 rounded-md flex justify-between items-center";
                div.innerHTML = `
                    <span class="font-bold">${tarea.titulo_epico}</span>
                    <div class="flex gap-2" data-task-id="${tarea.id}">
                        <button class="gandalf-choice-btn bg-green-800 text-white px-3 py-1 rounded" data-verdict="exito">√âxito</button>
                        <button class="gandalf-choice-btn bg-red-800 text-white px-3 py-1 rounded" data-verdict="fracaso">Fracaso</button>
                    </div>
                `;
                gandalfTaskList.appendChild(div);
            });
        }

        gandalfTaskList.addEventListener('click', (e) => {
            if (e.target.classList.contains('gandalf-choice-btn')) {
                const taskId = e.target.parentElement.dataset.taskId;
                const verdict = e.target.dataset.verdict;
                juiciosPendientes[taskId] = verdict;

                // Feedback visual
                e.target.parentElement.querySelectorAll('.gandalf-choice-btn').forEach(btn => {
                    btn.classList.remove('ring-4', 'ring-white');
                });
                e.target.classList.add('ring-4', 'ring-white');
            }
        });

        sellarJuicioBtn.addEventListener('click', async () => {
            const successIds = Object.keys(juiciosPendientes).filter(id => juiciosPendientes[id] === 'exito');
            const failureIds = Object.keys(juiciosPendientes).filter(id => juiciosPendientes[id] === 'fracaso');

            if (successIds.length === 0 && failureIds.length === 0) {
                alert("Debes emitir un juicio para cada asunto.");
                return;
            }

            const token = await obtenerToken();
            if(!token) return;

            try {
                await fetch('/api/gandalf/judge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ successIds, failureIds })
                });
                gandalfModal.classList.add('hidden');
                chatInput.disabled = false;
                chatInput.placeholder = "Escribe tu gesta aqu√≠, Frodo...";
                cargarMisiones(); // Recargamos para ver el resultado
            } catch (err) {
                console.error("Error al sellar el juicio:", err);
            }
        });


        // --- JUICIO DE GANDALF ---
        window.juicioGandalf = async (id, veredicto) => {
            const token = await obtenerToken();
            if (!token) return;

            const cardElement = document.querySelector(`[data-task-id="${id}"]`);

            if (veredicto === 'fracaso') {
                if (cardElement) {
                    cardElement.classList.add('task-card-failed');
                    const hordaContainer = cardElement.querySelector('.flex.gap-1.text-xs');
                    if(hordaContainer) {
                        hordaContainer.innerHTML += `<span class="text-xs text-red-400 animate-pulse">üå±</span>`;
                    }
                }
            } else {
                 if (cardElement) {
                    cardElement.style.transition = 'opacity 0.5s';
                    cardElement.style.opacity = '0';
                    setTimeout(() => cardElement.remove(), 500);
                }
            }

            const body = veredicto === 'exito' ? { successIds: [id] } : { failureIds: [id] };

            try {
                const res = await fetch('/api/gandalf/judge', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });
                if (!res.ok) {
                    // Si el backend falla, restauramos la UI para no mentir al usuario
                    console.error("Fallo del Juicio en el backend. Revirtiendo UI.");
                    cargarMisiones(); 
                }
                // Si el √©xito fue real, la tarjeta ya ha sido eliminada o marcada.
                // No es necesario un refresco completo, ahorramos una llamada de red.
                
            } catch (err) {
                console.error("Error en el juicio:", err);
                cargarMisiones(); // En caso de error de red, resincronizamos todo
            }
        };

        // --- PANEL DE DESARROLLADOR ---
        const devPanel = document.getElementById('devPanel');
        const daysOffsetInput = document.getElementById('daysOffset');
        const timeTravelBtn = document.getElementById('timeTravelBtn');

        // Activamos el panel si la URL contiene ?dev=true
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('dev') === 'true') {
            devPanel.classList.remove('hidden');
        }

        timeTravelBtn.addEventListener('click', () => {
            const offset = parseInt(daysOffsetInput.value, 10);
            const mockDate = new Date();
            mockDate.setDate(mockDate.getDate() + offset);
            
            console.log(`‚è≥ Viajando en el tiempo a: ${mockDate.toLocaleDateString()}`);
            cargarMisiones(mockDate);
        });

        // INICIO
        cargarMisiones();

    </script>
</body>
</html>